<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rental & Build Tracker</title>
  <style>
    :root{
      --bg:#f7f9fc; --card:#fff; --ink:#0f172a; --muted:#6b7280;
      --ink-soft:#334155; --line:#e5e7eb; --brand:#111827;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:.6rem;align-items:center;font-size:20px}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .nav a{display:inline-block;padding:8px 14px;border-radius:999px;background:#e5e7eb;color:#111827;text-decoration:none}
    .nav a.active{background:#111827;color:#fff}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .section-title{margin:0 0 12px 0;font-size:22px}
    .subsection-title{margin:24px 0 10px 0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
    .grid .col-span-2{grid-column:span 2}
    label{display:flex;flex-direction:column;gap:6px;color:var(--ink-soft);font-weight:500}
    input,select,textarea{height:40px;border:1px solid var(--line);border-radius:10px;padding:0 12px;background:#fff;color:var(--ink)}
    textarea{height:40px;resize:vertical;padding:10px 12px}
    input::placeholder{color:#9ca3af}
    .actions{display:flex;align-items:end}
    .btn{height:40px;padding:0 16px;border:none;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table-wrap{overflow:auto}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
    .footnote{color:var(--muted);margin:18px 2px}
    /* sections */
    section[data-view]{display:none}
    section[data-view].show{display:block}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span>üè†</span><strong>Rental & üîí Build Tracker</strong></div>
    <nav class="nav" id="nav">
      <a href="#income"   data-view="income">Income</a>
      <a href="#expenses" data-view="expenses">Expenses</a>
      <a href="#build"    data-view="build">Build</a>
      <a href="#admin"    data-view="admin">Admin</a>
      <a href="#reports"  data-view="reports">Reports</a>
      <a href="receipts.html">Receipts</a>
    </nav>
  </header>

  <main class="container">
    <!-- ============== INCOME (OG UI) ================= -->
    <section data-view="income" class="show">
      <h2 class="section-title">Add Income</h2>
      <div class="card">
        <form id="incomeForm" class="grid">
          <label><span>Property</span><select id="incomeProperty"></select></label>
          <label><span>Amount</span><input id="incomeAmount" type="number" step="0.01" inputmode="decimal" /></label>
          <label><span>Date</span><input id="incomeDate" type="date" /></label>

          <label><span>Account</span><select id="incomeAccount"></select></label>
          <label><span>Tenant</span><select id="incomeTenant"></select></label>
          <label><span>Source</span><input id="incomeSource" placeholder="Rent, Late Fee‚Ä¶" /></label>

          <label><span>Payment Type</span><input id="incomePayType" placeholder="ACH, Cash, Check‚Ä¶" /></label>
          <label class="col-span-2"><span>Note</span><input id="incomeNote" /></label>

          <div class="actions"><button type="submit" class="btn">Add Income</button></div>
        </form>
      </div>

      <h3 class="subsection-title">Recent Income</h3>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="incomeTable">
            <thead><tr><th>ID</th><th>Date</th><th>Amount</th><th>Property</th><th>Source</th><th>Pay Type</th><th>Note</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <p class="footnote">Public mode. Later we can add Supabase Auth + RLS. Ensure a Storage bucket named <code>receipts</code> exists and is public.</p>
    </section>

    <!-- ============== EXPENSES (OG style) ============ -->
    <section data-view="expenses">
      <h2 class="section-title">Add Expense</h2>
      <div class="card">
        <form id="expenseForm" class="grid">
          <label><span>Date</span><input id="expDate" type="date" /></label>
          <label><span>Amount</span><input id="expAmount" type="number" step="0.01" inputmode="decimal" /></label>
          <div></div>

          <label class="col-span-2"><span>Property</span><select id="expProperty"></select></label>
          <div class="actions"><button type="button" id="newPropBtn" class="btn" title="Quick add property">+ Property</button></div>

          <label class="col-span-2"><span>Vendor</span><select id="expVendor"></select></label>
          <div class="actions"><button type="button" id="newVendorBtn" class="btn" title="Quick add vendor">+ Vendor</button></div>

          <label class="col-span-2"><span>Category</span><select id="expCategory"></select></label>
          <div class="actions"><button type="button" id="newCatBtn" class="btn" title="Quick add category">+ Category</button></div>

          <label class="col-span-3"><span>Notes</span><textarea id="expNotes" placeholder="optional"></textarea></label>

          <div class="actions"><button type="submit" class="btn">Save Expense</button></div>
        </form>
      </div>

      <h3 class="subsection-title">Recent Expenses</h3>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="expenseTable">
            <thead><tr><th>Date</th><th>Property</th><th>Vendor</th><th>Category</th><th>Amount</th><th>Notes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- placeholders to keep the tabs from feeling empty -->
    <section data-view="build"><h2 class="section-title">Build</h2><div class="card">Coming soon.</div></section>
    <section data-view="admin"><h2 class="section-title">Admin</h2><div class="card">Coming soon.</div></section>
    <section data-view="reports"><h2 class="section-title">Reports</h2><div class="card">Coming soon.</div></section>
  </main>

  <!-- ======== Supabase + App Logic (all inline) ========= -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ‚¨áÔ∏è Fill these in
    const SUPABASE_URL  = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON = "YOUR_SUPABASE_ANON_KEY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---------- Simple tab routing (no extra files) ----------
    const sections = [...document.querySelectorAll('section[data-view]')];
    const navLinks = [...document.querySelectorAll('#nav a[href^="#"]')];
    function show(view){
      sections.forEach(s=>s.classList.toggle('show', s.dataset.view===view));
      navLinks.forEach(a=>a.classList.toggle('active', a.dataset.view===view));
      if (!view) location.hash = '#income';
    }
    function fromHash(){
      const v = (location.hash||'#income').replace('#','');
      show(v);
    }
    window.addEventListener('hashchange', fromHash);
    fromHash();

    // ---------- Helpers ----------
    const $ = (id)=>document.getElementById(id);
    const today = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };

    // default dates
    $('incomeDate').value = today();
    $('expDate').value    = today();

    // ---------- Load select options ----------
    async function loadIncomeOptions(){
      const [props, accts, tenants] = await Promise.all([
        supabase.from('properties').select('id,name').order('name'),
        supabase.from('accounts').select('id,name').order('name'),
        supabase.from('tenants').select('id,name').order('name'),
      ]);
      const propSel = $('incomeProperty'); propSel.innerHTML = `<option value="">‚Äî Choose ‚Äî</option>`;
      const acctSel = $('incomeAccount');  acctSel.innerHTML = `<option value="">‚Äî Choose ‚Äî</option>`;
      const tenSel  = $('incomeTenant');   tenSel .innerHTML = `<option value="">‚Äî Choose ‚Äî</option>`;
      for (const r of props.data || []) propSel.insertAdjacentHTML('beforeend', `<option value="${r.id}">${r.name}</option>`);
      for (const r of accts.data || []) acctSel.insertAdjacentHTML('beforeend', `<option value="${r.id}">${r.name}</option>`);
      for (const r of tenants.data || []) tenSel.insertAdjacentHTML('beforeend', `<option value="${r.id}">${r.name}</option>`);
    }
    async function loadExpenseOptions(){
      const [props, vendors, cats] = await Promise.all([
        supabase.from('properties').select('id,name').order('name'),
        supabase.from('vendors').select('id,name').order('name'),
        supabase.from('expense_categories').select('id,name').order('name'),
      ]);
      const propSel = $('expProperty'); propSel.innerHTML = `<option value="">‚Äî Choose ‚Äî</option>`;
      const venSel  = $('expVendor');   venSel .innerHTML = `<option value="">‚Äî Choose ‚Äî</option>`;
      const catSel  = $('expCategory'); catSel .innerHTML = `<option value="">‚Äî Choose ‚Äî</option>`;
      for (const r of props.data || []) propSel.insertAdjacentHTML('beforeend', `<option value="${r.id}">${r.name}</option>`);
      for (const r of vendors.data || []) venSel .insertAdjacentHTML('beforeend', `<option value="${r.id}">${r.name}</option>`);
      for (const r of cats.data || [])    catSel .insertAdjacentHTML('beforeend', `<option value="${r.id}">${r.name}</option>`);
    }

    // ---------- Insert Income ----------
    $('incomeForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        property_id: $('incomeProperty').value || null,
        amount: Number($('incomeAmount').value || 0),
        date: $('incomeDate').value || null,
        account_id: $('incomeAccount').value || null,
        tenant_id: $('incomeTenant').value || null,
        source: $('incomeSource').value?.trim() || null,
        pay_type: $('incomePayType').value?.trim() || null,
        note: $('incomeNote').value?.trim() || null,
      };
      const { error } = await supabase.from('income').insert(payload);
      if (error) return alert('Error: '+error.message);
      e.target.reset();
      $('incomeDate').value = today();
      loadRecentIncome();
    });

    // ---------- Insert Expense ----------
    $('expenseForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        date: $('expDate').value || null,
        amount: Number($('expAmount').value || 0),
        property_id: $('expProperty').value || null,
        vendor_id: $('expVendor').value || null,
        category_id: $('expCategory').value || null,
        notes: $('expNotes').value?.trim() || null,   // uses `notes` column you added
      };
      const { error } = await supabase.from('expenses').insert(payload);
      if (error) return alert('Error: '+error.message);
      e.target.reset();
      $('expDate').value = today();
      loadRecentExpenses();
    });

    // ---------- Quick-add buttons (minimal inline prompts) ----------
    async function quickAdd(table, name){
      const val = prompt(`New ${name} name?`); if (!val) return;
      const { error } = await supabase.from(table).insert({ name: val.trim() });
      if (error) alert('Error: '+error.message);
      await Promise.all([loadIncomeOptions(), loadExpenseOptions()]);
    }
    $('newPropBtn').addEventListener('click', ()=>quickAdd('properties','property'));
    $('newVendorBtn').addEventListener('click',()=>quickAdd('vendors','vendor'));
    $('newCatBtn').addEventListener('click',   ()=>quickAdd('expense_categories','category'));

    // ---------- Recent tables ----------
    async function loadRecentIncome(){
      const { data, error } = await supabase
        .from('income')
        .select(`
          id, date, amount, source, pay_type, note,
          properties:properties(name)
        `)
        .order('date', { ascending:false })
        .limit(25);
      const tb = document.querySelector('#incomeTable tbody');
      tb.innerHTML = '';
      if (error) { tb.innerHTML = `<tr><td colspan="7">Error: ${error.message}</td></tr>`; return; }
      for (const r of data||[]){
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${r.id ?? ''}</td>
            <td>${r.date ?? ''}</td>
            <td>${(r.amount ?? 0).toFixed?.(2) ?? r.amount}</td>
            <td>${r.properties?.name ?? ''}</td>
            <td>${r.source ?? ''}</td>
            <td>${r.pay_type ?? ''}</td>
            <td>${r.note ?? ''}</td>
          </tr>`);
      }
    }
    async function loadRecentExpenses(){
      const { data, error } = await supabase
        .from('expenses')
        .select(`
          date, amount, notes,
          properties:properties(name),
          vendors:vendors(name),
          categories:expense_categories(name)
        `)
        .order('date', { ascending:false })
        .limit(25);
      const tb = document.querySelector('#expenseTable tbody');
      tb.innerHTML = '';
      if (error) { tb.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`; return; }
      for (const r of data||[]){
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${r.date ?? ''}</td>
            <td>${r.properties?.name ?? ''}</td>
            <td>${r.vendors?.name ?? ''}</td>
            <td>${r.categories?.name ?? ''}</td>
            <td>${(r.amount ?? 0).toFixed?.(2) ?? r.amount}</td>
            <td>${r.notes ?? ''}</td>
          </tr>`);
      }
    }

    // ---------- Boot ----------
    await Promise.all([loadIncomeOptions(), loadExpenseOptions()]);
    await Promise.all([loadRecentIncome(), loadRecentExpenses()]);
  </script>
</body>
</html>
