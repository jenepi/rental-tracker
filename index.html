<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rental Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    header { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid #eee; }
    header h1 { font-size:20px; margin:0; }
    nav { margin-left:auto; display:flex; gap:8px; }
    nav a, nav button { text-decoration:none; border:1px solid #ddd; padding:6px 10px; border-radius:6px; background:#fff; cursor:pointer; }
    .container { padding:16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    fieldset { border:1px solid #eee; border-radius:8px; padding:12px; }
    legend { padding:0 6px; color:#444; }
    label { display:block; font-size:12px; color:#555; margin-top:8px; }
    input, select, textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    button.primary { background:#1a73e8; color:#fff; border:0; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
    #toast { position:fixed; right:12px; bottom:12px; background:#111; color:#fff; padding:10px 12px; border-radius:8px; opacity:0; transform:translateY(8px); transition:.2s; }
    #toast.show { opacity:1; transform:translateY(0); }
    .hidden { display:none; }
    .row { display:flex; gap:8px; align-items:center; }
    .inline-btn { padding:6px 8px; border:1px solid #ccc; background:#fafafa; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Rental Tracker</h1>
    <nav>
      <button id="tab-expenses">Expenses</button>
      <button id="tab-reports">Reports</button>
      <a href="./receipts.html">Receipts</a>
    </nav>
  </header>

  <div class="container">
    <!-- Expenses Tab -->
    <section id="expensesView">
      <div class="grid">
        <fieldset>
          <legend>Add Expense</legend>
          <div class="row">
            <label style="flex:1">
              Date
              <input type="date" id="exp_date" />
            </label>
            <label style="flex:1">
              Amount
              <input type="number" step="0.01" id="exp_amount" placeholder="0.00"/>
            </label>
          </div>

          <label>
            Property
            <div class="row">
              <select id="exp_property" style="flex:1"></select>
              <button class="inline-btn" id="addPropertyBtn" title="Quick add property">+</button>
            </div>
          </label>

          <label>
            Vendor
            <div class="row">
              <select id="exp_vendor" style="flex:1"></select>
              <button class="inline-btn" id="addVendorBtn" title="Quick add vendor">+</button>
            </div>
          </label>

          <label>
            Category
            <div class="row">
              <select id="exp_category" style="flex:1"></select>
              <button class="inline-btn" id="addCategoryBtn" title="Quick add category">+</button>
            </div>
          </label>

          <label>
            Notes
            <textarea id="exp_notes" rows="2" placeholder="optional"></textarea>
          </label>

          <div class="row" style="margin-top:10px">
            <button class="primary" id="saveExpenseBtn">Save Expense</button>
          </div>
        </fieldset>

        <fieldset>
          <legend>Recent Expenses</legend>
          <table id="expensesTable">
            <thead>
              <tr><th>Date</th><th>Property</th><th>Vendor</th><th>Category</th><th style="text-align:right">Amount</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </fieldset>
      </div>
    </section>

    <!-- Reports Tab -->
    <section id="reportsView" class="hidden">
      <fieldset>
        <legend>Profit & Loss (quick)</legend>
        <div class="row">
          <label style="flex:1">
            Year
            <input type="number" id="rpt_year" value="2025" />
          </label>
          <button id="runPnLBtn">Run</button>
        </div>
        <div id="pnlResult" style="margin-top:10px"></div>
      </fieldset>
    </section>
  </div>

  <div id="toast"></div>

  <!-- Supabase (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    // ======= CONFIG (use same project creds) =======
    const SUPABASE_URL = "https://hbgtxqlmlqkvmnpfkczj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZ3R4cWxtbHFrdm1ucGZrY3pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1MzA0NjksImV4cCI6MjA2MzEwNjQ2OX0.3t7q9rwuLZx3u21-L3xyeudTrMJ8QhbcFve36j2656g";
    // ======= TABLE NAMES (adjust if yours differ) ===
    const TBL_EXPENSES = "expenses";
    const TBL_PROPERTIES = "properties";
    const TBL_VENDORS = "vendors";
    const TBL_CATEGORIES = "expense_categories";
    // ===============================================

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI helpers
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => { const t = $('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); };

    // Tabs
    $('tab-expenses').onclick = () => { $('expensesView').classList.remove('hidden'); $('reportsView').classList.add('hidden'); };
    $('tab-reports').onclick = () => { $('reportsView').classList.remove('hidden'); $('expensesView').classList.add('hidden'); };

    // Populate dropdowns
    async function populateSelect(table, selectId, labelField="name", valueField="id") {
      const sel = $(selectId);
      sel.innerHTML = '<option value="">Loading...</option>';
      const { data, error } = await sb.from(table).select(`${valueField}, ${labelField}`).order(labelField, { ascending: true });
      if (error) { sel.innerHTML = `<option>Error</option>`; console.error(error); return; }
      sel.innerHTML = '<option value="">— choose —</option>' + data.map(r => `<option value="${r[valueField]}">${r[labelField]}</option>`).join('');
    }

    // Quick add helpers
    async function quickAdd(table, promptLabel, labelField="name") {
      const val = prompt(`New ${promptLabel} name?`);
      if (!val) return;
      const { error } = await sb.from(table).insert({ [labelField]: val });
      if (error) { alert(error.message); return; }
      toast(`${promptLabel} added`);
      return val;
    }

    $('addPropertyBtn').onclick = async () => { const added = await quickAdd(TBL_PROPERTIES, 'property', 'name'); if (added) populateSelect(TBL_PROPERTIES, 'exp_property'); };
    $('addVendorBtn').onclick = async () => { const added = await quickAdd(TBL_VENDORS, 'vendor', 'name'); if (added) populateSelect(TBL_VENDORS, 'exp_vendor'); };
    $('addCategoryBtn').onclick = async () => { const added = await quickAdd(TBL_CATEGORIES, 'category', 'name'); if (added) populateSelect(TBL_CATEGORIES, 'exp_category'); };

    // Save expense
    $('saveExpenseBtn').onclick = async () => {
      const row = {
        date: $('exp_date').value || new Date().toISOString().slice(0,10),
        amount: Number($('exp_amount').value || 0),
        property_id: $('exp_property').value || null,
        vendor_id: $('exp_vendor').value || null,
        category_id: $('exp_category').value || null,
        notes: $('exp_notes').value || null
      };
      if (!row.amount) return alert('Amount is required.');
      const { error } = await sb.from(TBL_EXPENSES).insert(row);
      if (error) return alert(error.message);
      toast('Expense saved');
      $('exp_amount').value = '';
      $('exp_notes').value = '';
      loadRecentExpenses();
    };

    // Load recent expenses
    async function loadRecentExpenses(limit=20) {
      const tbody = $('expensesTable').querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading…</td></tr>';
      const { data, error } = await sb
        .from(TBL_EXPENSES)
        .select(`
          date,
          amount,
          notes,
          vendor:${TBL_VENDORS}(name),
          category:${TBL_CATEGORIES}(name),
          property:${TBL_PROPERTIES}(name)
        `)
        .order('date', { ascending:false })
        .limit(limit);

      if (error) { tbody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`; return; }

      tbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.date ?? ''}</td>
          <td>${r.property?.name ?? ''}</td>
          <td>${r.vendor?.name ?? ''}</td>
          <td>${r.category?.name ?? ''}</td>
          <td style="text-align:right">$${Number(r.amount||0).toFixed(2)}</td>
        </tr>
      `).join('');
    }

    // Simple P&L (year)
    $('runPnLBtn').onclick = async () => {
      const year = Number($('rpt_year').value);
      const start = `${year}-01-01`;
      const end   = `${year+1}-01-01`;
      const { data, error } = await sb.from(TBL_EXPENSES)
        .select('amount')
        .gte('date', start).lt('date', end);

      if (error) { $('pnlResult').textContent = error.message; return; }
      const total = (data || []).reduce((s, r) => s + Number(r.amount || 0), 0);
      $('pnlResult').innerHTML = `<strong>Expenses ${year}:</strong> $${total.toFixed(2)} (basic total)`;
    };

    // Init
    (async function init() {
      await Promise.all([
        populateSelect(TBL_PROPERTIES, 'exp_property', 'name', 'id'),
        populateSelect(TBL_VENDORS, 'exp_vendor', 'name', 'id'),
        populateSelect(TBL_CATEGORIES, 'exp_category', 'name', 'id'),
      ]);
      loadRecentExpenses();
    })();
  </script>
</body>
</html>
